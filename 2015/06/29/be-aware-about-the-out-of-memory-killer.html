<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>Be aware about the out-of-memory killer - Ragnarson Blog</title><meta content="summary" name="twitter:card" /><meta content="@ragnarsoncom" name="twitter:site" /><meta content="Ragnarson Blog" property="og:site_name" /><meta content="article" property="og:type" /><meta content="https://blog.ragnarson.com/2015/06/29/be-aware-about-the-out-of-memory-killer.html" property="og:url" /><meta content="Be aware about the out-of-memory killer" property="og:title" /><meta content="One of the most important things for applications is stability. There are various hosting platforms that give you virtual servers, where you can run multiple services. There is no limit to the number of processes so it is up to you how much of their..." property="og:description" /><meta content="Maciej Małecki" name="author" /><meta content="https://blog.ragnarson.com/images/blog-embed-c040007b71.png" property="og:image" /><meta content="@smefju" name="twitter:creator" /><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Lato:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":"Ragnarson Blog","url":"https://blog.ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Person","name":"Maciej Małecki","image":"https://www.gravatar.com/avatar/6b844a73471cf2b060cb54d0b2f16161.jpg?s=144&d=mm"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","headline":"Be aware about the out-of-memory killer","url":"https://blog.ragnarson.com/2015/06/29/be-aware-about-the-out-of-memory-killer.html","author":{"@type":"Person","name":"Maciej Małecki","image":"https://www.gravatar.com/avatar/6b844a73471cf2b060cb54d0b2f16161.jpg?s=144&d=mm"},"publisher":{"@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com","logo":"https://blog.ragnarson.com/images/brand-c0054f1cec.svg"},"datePublished":"2015-06-29","dateModified":"2015-06-29"}</script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/stylesheets/application-c0f3339569.css" rel="stylesheet" /><link href="/favicon-152-c0fe5a334d.png" rel="apple-touch-icon-precomposed" /><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-11839548-2');
ga('set', 'allowAdFeatures', false);
ga('set', 'anonymizeIp', true);
ga('send', 'pageview');
</script>
</head><body><div class="container nav-container"><nav class="navbar navbar-dark navbar-toggleable-md"><button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" data-target="#navbarResponsive" data-toggle="collapse" type="button"><i class="icon-menu"></i></button><a href="https://ragnarson.com" class="nav-brand navbar-logo"><img src="/images/brand-c0054f1cec.svg" title="Ragnarson Blog" width="220px" alt="Brand" /></a><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="nav navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Why us</a><div class="dropdown-menu"><a href="https://ragnarson.com/manifesto" class="dropdown-item">Manifesto</a><a href="https://ragnarson.com/team" class="dropdown-item">Team</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Services</a><div class="dropdown-menu"><a href="https://ragnarson.com/software-development" class="dropdown-item">Software Development</a><a href="https://ragnarson.com/fund" class="dropdown-item">Fund</a><a href="https://ragnarson.com/advisory" class="dropdown-item">Advisory</a></div></li><li class="nav-item"><a href="https://ragnarson.com/case-studies" class="nav-link">Case studies</a></li><li class="nav-item"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-header#the-contact-form" class="nav-link">Contact</a></li><li class="nav-item"><a href="/" class="active nav-link">Blog</a></li><li class="nav-item"><a href="https://ragnarson.com/careers" class="nav-link">Careers</a></li></ul></div></nav></div><div class="newsletter-show newsletter-container" id="js-box"><div class="newsletter-toggler"><i class="icon-chevron-right" id="js-arrow"></i></div><div class="newsletter-box"><div class="newsletter-popup"><div id="mc_embed_signup">
  <form action="//ragnarson.us10.list-manage.com/subscribe/post?u=6a4a4d00f989604300f83d3de&amp;id=6adadf2f44" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL" class="newsletter-label">
        Sign up for our newsletter and get notifications about new articles on your email
      </label>

      <div class="row">
        <div class="three-thirds">
          <input type="email" value="" name="EMAIL" class="newsletter-input" id="mce-EMAIL" placeholder="Your email address" required>

          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
          <div class="signup_hidden">
            <input type="text" name="b_6a4a4d00f989604300f83d3de_6adadf2f44" tabindex="-1" value="" class="one-half">
          </div>
        </div>

        <div class="mt-3 text-center">
          <input type="submit" value="Join our newsletter" name="subscribe" id="mc-embedded-subscribe" class="btn newsletter-btn">
        </div>
      </div>
    </div>
  </form>
</div>
</div></div></div><div id="main" role="main"><div class="article"><header><img src="https://www.gravatar.com/avatar/6b844a73471cf2b060cb54d0b2f16161.jpg?s=144&amp;d=mm" class="avatar" width="72px" size="72px" alt="6b844a73471cf2b060cb54d0b2f16161" /><div class="article-meta">June 29, 2015 - <a href="/authors/maciej-malecki.html">Maciej Małecki</a>  in <a href="/categories/development.html">development</a></div><h1 class="article-title"><a href="/2015/06/29/be-aware-about-the-out-of-memory-killer.html">Be aware about the out-of-memory killer</a></h1></header><div class="article-notice">This article was originally posted on the Shelly Cloud blog, our Ruby
platform as a service that we have decided to shut down on October 2015.</div><p>One of the most important things for applications is stability. There are various hosting platforms that give you virtual servers, where you can run multiple services. There is no limit to the number of processes so it is up to you how much of their resources will be used. However, exceeding all available RAM memory can result in poor stability or even a server crash. This article gives you some basic knowledge about the <em>out-of-memory</em> system state.</p>

<p><em>OOM</em> is a state where there is no memory available for the system. In such a situation, Kernel will invoke <em>oom-killer</em> to choose and sacrifice some processes, to free up the memory. It may force-kill your puma webservers, sidekiq workers or database.</p>
<figure>
<p><img src="/2015/06/29/be-aware-about-the-out-of-memory-killer/newrelic-c0f3bc7a53.png" alt="New Reilc" /></p>
</figure>
<p>The server stopped reporting stats to NewRelic at around 11:41. Memory usage (RAM and SWAP) exceeded all server resources and <em>oom-killer</em> killed NewRelic daemon, and other processes, to free up the memory.</p>
<pre class="highlight shell"><code><span class="gp">root@i-10-255-3-105[staging]:~# </span>grep -i <span class="nb">kill</span> /var/log/syslog
Jun 17 11:41:37 i-10-255-3-105 kernel: <span class="o">[</span>54493.290148] ruby invoked oom-killer: <span class="nv">gfp_mask</span><span class="o">=</span>0x201da, <span class="nv">order</span><span class="o">=</span>0, <span class="nv">oom_score_adj</span><span class="o">=</span>0
<span class="o">[</span>...]
Jun 17 11:41:41 i-10-255-3-105 kernel: <span class="o">[</span>54498.831237] Out of memory: Kill process 32236 <span class="o">(</span>ruby<span class="o">)</span> score 912 or sacrifice child
Jun 17 11:41:41 i-10-255-3-105 kernel: <span class="o">[</span>54498.831894] Killed process 32236 <span class="o">(</span>ruby<span class="o">)</span> total-vm:209732kB, anon-rss:921340kB, file-rss:0kB
<span class="o">[</span>...]
</code></pre>

<h2>OOM Score</h2>

<p>There are various factors taken into consideration for calculating the priority for killing a given process. One of them is <em>oom score adjustment</em>. The user can adjust the priority by using a special file placed in <a href="http://man7.org/linux/man-pages/man5/proc.5.html">process information pseudo-filesystem</a> called <code>/proc</code></p>
<pre class="highlight shell"><code><span class="c"># set the highest priority</span>
<span class="nb">echo </span>1000 &gt; /proc/[PID]/oom_score_adj

<span class="c"># set the lowest priority</span>
<span class="nb">echo</span> -1000 &gt; /proc/[PID]/oom_score_adj
</code></pre>

<p>The highest priority means that the particular process will always be marked for killing in the case of an <em>out-of-memory</em> state. However, the process with the lowest priority will only be killed if there are no other processes with a higher score. <code>oom_score_adj</code> can be used as one factor for calculating the <code>oom_score</code>, which is used by <em>oom-killer</em> as a final score.</p>

<p>Shelly Cloud sets the lowest priority for critical services such as sshd, monitoring or databases and the highest priority for application services.</p>

<h2>Monitoring</h2>

<p>Monitoring is a key factor in such situations. If a process was killed by kernel there should be a service that will bring it back to action. Otherwise the server may become unresponsive and only a complete restart will help.</p>

<p>Each virtual server on Shelly Cloud has its own monitoring.</p>

<h2>Conclusion</h2>

<p>You should always keep an eye on the available resources to avoid dangerous situations. We recommend <a href="https://shellycloud.com/documentation/faq#new_relic">NewRelic</a> and their free plan for monitoring server resources. It allows you to set up an alert if RAM usage is too high. Graphs can help recognize if there is a memory leak, or if your application needs more resources.</p>
<div class="work-with-us"><p>At Ragnarson we help companies deliver great products. We take care of development and deployment so that they can focus on growing the product and working with customers.</p><a class="btn" href="https://ragnarson.com/?utm_source=ragnarson&utm_medium=blog&utm_campaign=work-with-us#contact">Work with us</a></div><div class="article-comments"><div id="commento"></div>
<script src="https://cdn.commento.io/js/commento.js"></script>
</div></div><footer><div class="text--center"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-footer"><img src="/images/ragnar-desk-c0d025368e.png" srcset="/images/ragnar-desk-c0d025368e.png 1x, /images/ragnar-desk-2x-c0332b062e.png 2x" alt="Ragnar desk" /></a></div></footer></div><script src="/javascripts/application-c0ec307bf9.js"></script></body></html>