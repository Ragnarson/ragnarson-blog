<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>Multi-model searching using Elasticsearch vol. 2 - Ragnarson Blog</title><meta content="summary" name="twitter:card" /><meta content="@ragnarsoncom" name="twitter:site" /><meta content="Ragnarson Blog" property="og:site_name" /><meta content="article" property="og:type" /><meta content="https://blog.ragnarson.com/2016/07/14/multi-model-searching-elasticsearch-2.html" property="og:url" /><meta content="Multi-model searching using Elasticsearch vol. 2" property="og:title" /><meta content="In the previous post
we saw how to install Elasticsearch and import data needed for searching. We also set up basic
searching for the User and House models. In the next post we will see how to improve searching
intelligence, but right now let’s take care of the main part of our functionality - multi model searching." property="og:description" /><meta content="Dawid Lenkiewicz" name="author" /><meta content="https://blog.ragnarson.com/2016/07/14/multi-model-searching-elasticsearch-2/cover-c0768818da.png" property="og:image" /><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Lato:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":"Ragnarson Blog","url":"https://blog.ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Person","name":"Dawid Lenkiewicz","image":"https://www.gravatar.com/avatar/01caa77a1f122a1371fed292cab37c72.jpg?s=144&d=mm"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","headline":"Multi-model searching using Elasticsearch vol. 2","url":"https://blog.ragnarson.com/2016/07/14/multi-model-searching-elasticsearch-2.html","author":{"@type":"Person","name":"Dawid Lenkiewicz","image":"https://www.gravatar.com/avatar/01caa77a1f122a1371fed292cab37c72.jpg?s=144&d=mm"},"publisher":{"@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com","logo":"https://blog.ragnarson.com/images/brand-c0054f1cec.svg"},"datePublished":"2016-07-14","dateModified":"2016-07-14","image":"https://blog.ragnarson.com/2016/07/14/multi-model-searching-elasticsearch-2/cover-c0768818da.png"}</script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/stylesheets/application-c0f3339569.css" rel="stylesheet" /><link href="/favicon-152-c0fe5a334d.png" rel="apple-touch-icon-precomposed" /><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-11839548-2');
ga('set', 'allowAdFeatures', false);
ga('set', 'anonymizeIp', true);
ga('send', 'pageview');
</script>
</head><body><div class="container nav-container"><nav class="navbar navbar-dark navbar-toggleable-md"><button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" data-target="#navbarResponsive" data-toggle="collapse" type="button"><i class="icon-menu"></i></button><a href="https://ragnarson.com" class="nav-brand navbar-logo"><img src="/images/brand-c0054f1cec.svg" title="Ragnarson Blog" width="220px" alt="Brand" /></a><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="nav navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Why us</a><div class="dropdown-menu"><a href="https://ragnarson.com/our-story/" class="dropdown-item">Our story</a><a href="https://ragnarson.com/core-values/" class="dropdown-item">Core Values</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Services</a><div class="dropdown-menu"><a href="https://ragnarson.com/services/web-app-development/" class="dropdown-item">Web app development</a><a href="https://ragnarson.com/services/infrastructure-and-devops/" class="dropdown-item">Infrastructure and DevOps</a></div></li><li class="nav-item"><a href="https://ragnarson.com/case-studies/" class="nav-link">Case studies</a></li><li class="nav-item"><a href="https://ragnarson.com/community/" class="nav-link">Community</a></li><li class="nav-item"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-header#contact" class="nav-link">Contact</a></li><li class="nav-item"><a href="/" class="active nav-link">Blog</a></li><li class="nav-item"><a href="http://jobs.ragnarson.com" class="nav-link">Jobs</a></li></ul></div></nav></div><div class="newsletter-show newsletter-container" id="js-box"><div class="newsletter-toggler"><i class="icon-chevron-right" id="js-arrow"></i></div><div class="newsletter-box"><div class="newsletter-popup"><div id="mc_embed_signup">
  <form action="//ragnarson.us10.list-manage.com/subscribe/post?u=6a4a4d00f989604300f83d3de&amp;id=6adadf2f44" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL" class="newsletter-label">
        Sign up for our newsletter and get notifications about new articles on your email
      </label>

      <div class="row">
        <div class="three-thirds">
          <input type="email" value="" name="EMAIL" class="newsletter-input" id="mce-EMAIL" placeholder="Your email address" required>

          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
          <div class="signup_hidden">
            <input type="text" name="b_6a4a4d00f989604300f83d3de_6adadf2f44" tabindex="-1" value="" class="one-half">
          </div>
        </div>

        <div class="mt-3 text-center">
          <input type="submit" value="Join our newsletter" name="subscribe" id="mc-embedded-subscribe" class="btn newsletter-btn">
        </div>
      </div>
    </div>
  </form>
</div>
</div></div></div><div id="main" role="main"><div class="article"><header><img src="https://www.gravatar.com/avatar/01caa77a1f122a1371fed292cab37c72.jpg?s=144&amp;d=mm" class="avatar" width="72px" size="72px" alt="01caa77a1f122a1371fed292cab37c72" /><div class="article-meta">July 14, 2016 - <a href="/authors/dawid-lenkiewicz.html">Dawid Lenkiewicz</a>  in <a href="/categories/development.html">development</a></div><h1 class="article-title"><a href="/2016/07/14/multi-model-searching-elasticsearch-2.html">Multi-model searching using Elasticsearch vol. 2</a></h1></header><img src='/2016/07/14/multi-model-searching-elasticsearch-2/cover-c0768818da.png'/><p>In the <a href="http://blog.ragnarson.com/2016/06/30/multi_model_searching_elasticsearch_1.html">previous post</a>
we saw how to install Elasticsearch and import data needed for searching. We also set up basic
searching for the <code>User</code> and <code>House</code> models. In the next post we will see how to improve searching
intelligence, but right now let’s take care of the main part of our functionality - multi model searching.</p>

<p></p>

<hr>

<p>This a part of a three post series:</p>

<ol>
<li><p><a href="http://blog.ragnarson.com/2016/06/30/multi_model_searching_elasticsearch_1.html">Part 1 - basic setup</a></p></li>
<li><p><a href="http://blog.ragnarson.com/2016/07/14/multi-model-searching-elasticsearch-2.html">Part 2 - multi model searching</a></p></li>
<li><p><a href="http://blog.ragnarson.com/2016/07/21/multi-model-searching-elasticsearch-3.html">Part 3 - improving searching intelligence</a></p></li>
</ol>

<hr>

<h2>TL;DR</h2>

<p>I&#39;ve created a sample app which is a foundation for my blogposts. If you already are familiar with
Elasticsearch you can <a href="https://github.com/Ragnarson/elastic_search_demo">check it</a> out right away.
It&#39;s a complete demo with some complex searching using nGrams.</p>

<h2>Multi-model searching</h2>

<p>The <a href="https://github.com/elastic/elasticsearch-rails/tree/master/elasticsearch-model">elasticserch-model</a>
gem provides an easy way to search within multiple models:</p>
<pre class="highlight ruby"><code><span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Model</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">query_to_search</span><span class="p">,</span> <span class="p">[</span><span class="no">User</span><span class="p">,</span> <span class="no">House</span><span class="p">])</span>
</code></pre>

<p>As you can see the <code>search</code> method needs 2 arguments: your query to search by and an array of models.
So without further ado let’s create a service object which will be responsible for searching:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Autocompleter</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:query</span><span class="p">)</span>
  <span class="no">MODELS_TO_SEARCH</span> <span class="o">=</span> <span class="p">[</span><span class="no">User</span><span class="p">,</span> <span class="no">House</span><span class="p">]</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="kp">new</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="nf">call</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="n">results</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="o">|</span>
      <span class="p">{</span>
        <span class="ss">hint: </span><span class="n">build_hint</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
        <span class="ss">record_type: </span><span class="n">result</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
        <span class="ss">record_id: </span><span class="n">result</span><span class="p">.</span><span class="nf">id</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">results</span>
    <span class="no">Elasticsearch</span><span class="o">::</span><span class="no">Model</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="no">MODELS_TO_SEARCH</span><span class="p">).</span><span class="nf">records</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">build_hint</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">record</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">to_s</span>
    <span class="k">when</span> <span class="s2">"User"</span> <span class="k">then</span> <span class="s2">"Name: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">, City: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">city</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">when</span> <span class="s2">"House"</span> <span class="k">then</span> <span class="s2">"City: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">city</span><span class="si">}</span><span class="s2">, Info: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">information</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Calling <code>Autocompleter.call(“query”)</code> will return an array of hashes with matched data from both
models. If you are building some kind of form where user will be able to select some records
you basically can return 3 things from each result:</p>

<ul>
<li>Record type to know what kind of record user selected</li>
<li>Record id to know which record of given type user selected</li>
<li>Some kind of text describing given record which will be shown to a user. Let’s assume that
right now it should contain the most important columns from both models, like: <code>column_name: value, etc.</code>.
For example for User - <code>Name: “Dawid”, City: “Bialystok”</code></li>
</ul>

<h2>Presenting results</h2>

<p>So let’s stop for a while and talk about possible solutions for creating the description in the <code>build_hint</code> method:</p>

<ul>
<li>Right now it just uses a <code>case</code> conditional and returns specific text for given class</li>
</ul>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">build_hint</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">record</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">to_s</span>
  <span class="k">when</span> <span class="s2">"User"</span> <span class="k">then</span> <span class="s2">"Name: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">, City: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">city</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">when</span> <span class="s2">"House"</span> <span class="k">then</span> <span class="s2">"City: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">city</span><span class="si">}</span><span class="s2">, Info: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">information</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>It just doesn’t feel right. It is polluting the <code>Autocompleter</code> class with the knowledge of how to
present results, it would be difficult to test in isolation and with some possible changes in the future in can look even worse.</p>

<ul>
<li><p>You could write some specific method in each model or even overwrite the <code>to_s</code> method. It looks
like a better solution, but such method in a class tends to be overused later. What if you think
you are doing a good job and use it in some other place? Then changing the way we present search
results would also affect different place in our app. Also it looks like moving too much logic to
a model and can introduce the <a href="https://en.wikipedia.org/wiki/God_object">god object</a> anti-pattern.</p></li>
<li><p>So what is the best way to get rid of conditionals? Let’s use polymorphism. So the <code>build_hint</code>
method will only delegate it to another service object, which is responsible only for presenting
results. Here’s the whole implementation:</p></li>
</ul>
<pre class="highlight ruby"><code><span class="c1"># In Autocompleter</span>
<span class="k">def</span> <span class="nf">build_hint</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
  <span class="no">BuildHint</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">BuildHint</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:record</span><span class="p">)</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="kp">new</span><span class="p">(</span><span class="n">record</span><span class="p">).</span><span class="nf">call</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="n">result_builder</span><span class="p">.</span><span class="nf">autocomplete_hint</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">result_builder</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">ResultBuilder"</span><span class="p">.</span><span class="nf">constantize</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ResultBuilderBase</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="vi">@record</span> <span class="o">=</span> <span class="n">record</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="kp">attr_reader</span> <span class="ss">:record</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">HouseResultBuilder</span> <span class="o">&lt;</span> <span class="no">ResultBuilderBase</span>
  <span class="k">def</span> <span class="nf">autocomplete_hint</span>
    <span class="s2">"City: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">city</span><span class="si">}</span><span class="s2">, Info: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">information</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">UserResultBuilder</span> <span class="o">&lt;</span> <span class="no">ResultBuilderBase</span>
  <span class="k">def</span> <span class="nf">autocomplete_hint</span>
    <span class="s2">"Name: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">, City: </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">city</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>I really like this solution. Couple of small classes that are easy to read, understand and most
important part is that they are easy to test and change in the future without affecting anything else.</p>

<h2>Searching examples</h2>

<p>As in the previous post let’s create some data:</p>
<pre class="highlight ruby"><code><span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">city: </span><span class="s2">"San Francisco"</span><span class="p">)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Rambo"</span><span class="p">,</span> <span class="ss">city: </span><span class="s2">"New York"</span><span class="p">)</span>

<span class="no">House</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">city: </span><span class="s2">"New York"</span><span class="p">,</span> <span class="ss">information: </span><span class="s2">"Rambo’s house"</span><span class="p">)</span>
<span class="no">House</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">city: </span><span class="s2">"Los Angeles"</span><span class="p">,</span> <span class="ss">information: </span><span class="s2">"Large villa"</span><span class="p">)</span>
</code></pre>

<p>And now it’s time to see how it works:</p>
<pre class="highlight ruby"><code><span class="no">Autocompleter</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s2">"rambo"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">[{</span><span class="ss">:hint</span><span class="o">=&gt;</span><span class="s2">"City: New York, Info: Rambo’s house"</span><span class="p">,</span> <span class="ss">:record_type</span><span class="o">=&gt;</span><span class="s2">"House"</span><span class="p">,</span> <span class="ss">:record_id</span><span class="o">=&gt;</span><span class="mi">12</span><span class="p">},</span>
<span class="p">{</span><span class="ss">:hint</span><span class="o">=&gt;</span><span class="s2">"Name: John Rambo, City: New York"</span><span class="p">,</span> <span class="ss">:record_type</span><span class="o">=&gt;</span><span class="s2">"User"</span><span class="p">,</span> <span class="ss">:record_id</span><span class="o">=&gt;</span><span class="mi">16</span><span class="p">}]</span>

<span class="no">Autocompleter</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s2">"john"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">[{</span><span class="ss">:hint</span><span class="o">=&gt;</span><span class="s2">"Name: John Rambo, City: New York"</span><span class="p">,</span> <span class="ss">:record_type</span><span class="o">=&gt;</span><span class="s2">"User"</span><span class="p">,</span> <span class="ss">:record_id</span><span class="o">=&gt;</span><span class="mi">16</span><span class="p">},</span>
<span class="p">{</span><span class="ss">:hint</span><span class="o">=&gt;</span><span class="s2">"Name: John Doe, City: San Francisco"</span><span class="p">,</span> <span class="ss">:record_type</span><span class="o">=&gt;</span><span class="s2">"User"</span><span class="p">,</span> <span class="ss">:record_id</span><span class="o">=&gt;</span><span class="mi">14</span><span class="p">}]</span>

<span class="no">Autocompleter</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s2">"new york"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">[{</span><span class="ss">:hint</span><span class="o">=&gt;</span><span class="s2">"City: New York, Info: Rambo’s house"</span><span class="p">,</span> <span class="ss">:record_type</span><span class="o">=&gt;</span><span class="s2">"House"</span><span class="p">,</span> <span class="ss">:record_id</span><span class="o">=&gt;</span><span class="mi">12</span><span class="p">},</span>
<span class="p">{</span><span class="ss">:hint</span><span class="o">=&gt;</span><span class="s2">"Name: John Rambo, City: New York"</span><span class="p">,</span> <span class="ss">:record_type</span><span class="o">=&gt;</span><span class="s2">"User"</span><span class="p">,</span> <span class="ss">:record_id</span><span class="o">=&gt;</span><span class="mi">16</span><span class="p">}]</span>
</code></pre>

<p>Pretty cool, right? Seems like everything is working as expected.</p>

<h2>Wrapping up</h2>

<p>The most important functionality is already there. By now we got Elasticsearch running, importing
data automatically after each record update and made a multi-model search. In the next post
I’ll show you how you can improve the searching intelligence by specifying custom analyzers
when indexing and searching. Stay tuned and thanks for reading.</p>
<div class="work-with-us"><p>At Ragnarson we help companies deliver great products. We take care of development and deployment so that they can focus on growing the product and working with customers.</p><a class="btn" href="https://ragnarson.com/?utm_source=ragnarson&utm_medium=blog&utm_campaign=work-with-us#contact">Work with us</a></div><div class="article-comments"><div id="commento"></div>
<script src="https://cdn.commento.io/js/commento.js"></script>
</div></div><footer><div class="text--center"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-footer"><img src="/images/ragnar-desk-c0d025368e.png" srcset="/images/ragnar-desk-c0d025368e.png 1x, /images/ragnar-desk-2x-c0332b062e.png 2x" alt="Ragnar desk" /></a></div></footer></div><script src="/javascripts/application-c0ec307bf9.js"></script></body></html>