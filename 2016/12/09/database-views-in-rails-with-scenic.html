<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>Database Views in Rails with Scenic - Ragnarson Blog</title><meta content="summary" name="twitter:card" /><meta content="@ragnarsoncom" name="twitter:site" /><meta content="Ragnarson Blog" property="og:site_name" /><meta content="article" property="og:type" /><meta content="https://blog.ragnarson.com/2016/12/09/database-views-in-rails-with-scenic.html" property="og:url" /><meta content="Database Views in Rails with Scenic" property="og:title" /><meta content="This article describes how database views can be a solution for an application with complex relationships and how Scenic gem simplifies the task of implementing those views in your Rails application." property="og:description" /><meta content="Krzysztof Dąbrowski" name="author" /><meta content="https://blog.ragnarson.com/2016/12/09/database-views-in-rails-with-scenic/cover-c0b56cb0a9.png" property="og:image" /><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Lato:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":"Ragnarson Blog","url":"https://blog.ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Person","name":"Krzysztof Dąbrowski","image":"https://www.gravatar.com/avatar/bab00040ac23b4eb10fc4ff5eafff5db.jpg?s=144&d=mm"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","headline":"Database Views in Rails with Scenic","url":"https://blog.ragnarson.com/2016/12/09/database-views-in-rails-with-scenic.html","author":{"@type":"Person","name":"Krzysztof Dąbrowski","image":"https://www.gravatar.com/avatar/bab00040ac23b4eb10fc4ff5eafff5db.jpg?s=144&d=mm"},"publisher":{"@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com","logo":"https://blog.ragnarson.com/images/brand-c0054f1cec.svg"},"datePublished":"2016-12-09","dateModified":"2016-12-09","image":"https://blog.ragnarson.com/2016/12/09/database-views-in-rails-with-scenic/cover-c0b56cb0a9.png"}</script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/stylesheets/application-c0f3339569.css" rel="stylesheet" /><link href="/favicon-152-c0fe5a334d.png" rel="apple-touch-icon-precomposed" /><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-11839548-2');
ga('set', 'allowAdFeatures', false);
ga('set', 'anonymizeIp', true);
ga('send', 'pageview');
</script>
</head><body><div class="container nav-container"><nav class="navbar navbar-dark navbar-toggleable-md"><button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" data-target="#navbarResponsive" data-toggle="collapse" type="button"><i class="icon-menu"></i></button><a href="https://ragnarson.com" class="nav-brand navbar-logo"><img src="/images/brand-c0054f1cec.svg" title="Ragnarson Blog" width="220px" alt="Brand" /></a><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="nav navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Why us</a><div class="dropdown-menu"><a href="https://ragnarson.com/manifesto" class="dropdown-item">Manifesto</a><a href="https://ragnarson.com/team" class="dropdown-item">Team</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Services</a><div class="dropdown-menu"><a href="https://ragnarson.com/software-development" class="dropdown-item">Software Development</a><a href="https://ragnarson.com/fund" class="dropdown-item">Fund</a><a href="https://ragnarson.com/advisory" class="dropdown-item">Advisory</a></div></li><li class="nav-item"><a href="https://ragnarson.com/case-studies" class="nav-link">Case studies</a></li><li class="nav-item"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-header#the-contact-form" class="nav-link">Contact</a></li><li class="nav-item"><a href="/" class="active nav-link">Blog</a></li><li class="nav-item"><a href="https://ragnarson.com/careers" class="nav-link">Careers</a></li></ul></div></nav></div><div class="newsletter-show newsletter-container" id="js-box"><div class="newsletter-toggler"><i class="icon-chevron-right" id="js-arrow"></i></div><div class="newsletter-box"><div class="newsletter-popup"><div id="mc_embed_signup">
  <form action="//ragnarson.us10.list-manage.com/subscribe/post?u=6a4a4d00f989604300f83d3de&amp;id=6adadf2f44" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL" class="newsletter-label">
        Sign up for our newsletter and get notifications about new articles on your email
      </label>

      <div class="row">
        <div class="three-thirds">
          <input type="email" value="" name="EMAIL" class="newsletter-input" id="mce-EMAIL" placeholder="Your email address" required>

          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
          <div class="signup_hidden">
            <input type="text" name="b_6a4a4d00f989604300f83d3de_6adadf2f44" tabindex="-1" value="" class="one-half">
          </div>
        </div>

        <div class="mt-3 text-center">
          <input type="submit" value="Join our newsletter" name="subscribe" id="mc-embedded-subscribe" class="btn newsletter-btn">
        </div>
      </div>
    </div>
  </form>
</div>
</div></div></div><div id="main" role="main"><div class="article"><header><img src="https://www.gravatar.com/avatar/bab00040ac23b4eb10fc4ff5eafff5db.jpg?s=144&amp;d=mm" class="avatar" width="72px" size="72px" alt="Bab00040ac23b4eb10fc4ff5eafff5db" /><div class="article-meta">December  9, 2016 - <a href="/authors/krzysztof-dabrowski.html">Krzysztof Dąbrowski</a>  in <a href="/categories/development.html">development</a></div><h1 class="article-title"><a href="/2016/12/09/database-views-in-rails-with-scenic.html">Database Views in Rails with Scenic</a></h1></header><img src='/2016/12/09/database-views-in-rails-with-scenic/cover-c0b56cb0a9.png'/><p>This article describes how database views can be a solution for an application with complex relationships and how Scenic gem simplifies the task of implementing those views in your Rails application.</p>

<p></p>

<h1>The App</h1>

<p>The app we are currently working on is a customized management platform for software development agencies. Clients may have multiple projects, projects may have multiple developers, designers etc. The tree branches out pretty broadly in terms of a developer to project assignment as this is the core feature of the application.</p>

<h1>The Problem</h1>

<p>Our client asked for a view representing people’s availability for assignment to a new project. An employee is perceived as available if he meets any of the following criteria:</p>

<ul>
<li>is currently on an internal project</li>
<li>is in an external project that ends in less than one month in the future</li>
<li>is not assigned to any project</li>
</ul>

<p>The database structure in terms of user-to-project relation looks as follows:
<figure>
  <img src="/2016/12/09/database-views-in-rails-with-scenic/db_schema-c0868a6274.png" alt="Database Structure" />
</figure></p>

<h1>Possible solutions</h1>

<h2>Combined Scopes</h2>

<p>The first solution that came to us was to use multiple scopes and combine them together. This would be the most “rails way” approach. The drawback of the solution turned out to be the level of complexity. The building scopes would need to be scattered across the user and the project scopes. The query built by ActiveRecord would be far from optimal and simple. As a result, the code could be harder to understand and maintain.</p>

<h2>Flag record on the users table</h2>

<p>Another solution was to implement a flag that is going to store information if a user is available or not. The drawback of the solution would be the need to maintain a quite complicated callback structure that is going to update the user model every time the end_date changes.</p>

<p>The <code>end_date</code> stands for the end of an assignment for a developer. Not always the project end date is the same as the developer’s assignment end date. There are situations where a developer may be assigned only for a short period of time to complete a task or to help the team to meet a deadline.</p>

<p>The implementation would not be complicated but we want to avoid callbacks as they are difficult to maintain and blur the transparency of the database - model layer flow.</p>

<h2>Database Views</h2>

<p>The final solution that we came up with was to use database views to join multiple queries. This seemed to fit all our needs, as there would be a single query executed only if needed and there would be no callbacks required. A database view works like a “virtual” table and can be joined with other “physical” tables. We agreed that this solution was the most fitting and we gave it a shot.</p>

<h1>Implementation</h1>

<p>We’ve searched for a ready-made gem which implements an interface for managing database views and we’ve stumbled upon the Scenic gem from Thoughtbot:</p>

<p><a href="https://github.com/thoughtbot/scenic">https://github.com/thoughtbot/scenic</a></p>

<p>The gem had everything we needed and the implementation was somehow natural with Rails.
The view creation is very similar to a schema update and is triggered by <code>db:migrate</code>. Another great feature is that any created view works with ActiveRecord as a regular model and comes with all its native features. Scenic turned out be a perfect fit for our scenario.</p>

<h2>Installation:</h2>

<p>Add <code>scenic</code> to your Gemifle</p>

<p>Run:
<code>bundle install</code></p>

<p>To generate a view simply run:</p>

<p><code>rails generate scenic:view view_name</code></p>

<p>In our case, the view_name was <code>available_people</code></p>

<p>The last command created a new empty schema migration file in the following path:
<code>~/app/db/views/available_people_v01.sql</code></p>

<p>Contents of our available_people_v01.sql file:</p>
<pre class="highlight sql"><code><span class="k">SELECT</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="n">users</span>
<span class="k">JOIN</span> <span class="n">assignments</span> <span class="k">on</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">JOIN</span> <span class="n">projects</span> <span class="k">on</span> <span class="n">assignments</span><span class="p">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">projects</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span> <span class="n">assignments</span><span class="p">.</span><span class="n">end_date</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="s1">'1 month'</span><span class="p">::</span><span class="n">interval</span><span class="p">)</span> <span class="k">AND</span> <span class="n">projects</span><span class="p">.</span><span class="n">internal</span> <span class="o">=</span> <span class="k">false</span>

<span class="k">UNION</span>

<span class="k">SELECT</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="n">users</span>
<span class="k">JOIN</span> <span class="n">assignments</span> <span class="k">on</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">JOIN</span> <span class="n">projects</span> <span class="k">on</span> <span class="n">assignments</span><span class="p">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">projects</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span> <span class="n">projects</span><span class="p">.</span><span class="n">internal</span> <span class="o">=</span> <span class="k">true</span> <span class="k">AND</span> <span class="p">(</span><span class="n">assignments</span><span class="p">.</span><span class="n">end_date</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">()</span> <span class="k">OR</span> <span class="n">assignments</span><span class="p">.</span><span class="n">end_date</span> <span class="k">is</span> <span class="k">NULL</span><span class="p">)</span>

<span class="k">UNION</span>

<span class="k">SELECT</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="n">users</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">assignments</span> <span class="k">on</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">WHERE</span> <span class="n">assignments</span> <span class="k">is</span> <span class="k">NULL</span><span class="p">;</span>
</code></pre>

<p>We can access the view by using a simple sql query in a model or a scope. An advantage of this solution is putting the workload in the DB and keeping the implementation in the model to a bare minimum.</p>

<p>After the file was edited and filled in with our queries we were able to apply the view to our database by simply running:</p>

<p><code>rake db:migrate</code></p>

<p>The process for creating a view is similar to creating new table.</p>

<h2>The model layer</h2>

<p>We had two options to access the data from the view in the model. We could create a new model in Rails or use a direct query from the <code>User</code> model. In this case, we only needed to see if a given user_id was present in our view and scope the user model by it.</p>
<pre class="highlight ruby"><code><span class="c1"># app/models/user.rb</span>
<span class="n">scope</span> <span class="ss">:available</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">joins</span><span class="p">(</span><span class="s2">"JOIN available_people on users.id = available_people.id"</span><span class="p">)</span> <span class="p">}</span>
</code></pre>

<p>Now, we could use our database view with the <code>User</code> model. We can always create a model for the database view in case we need to do any data manipulation on it.</p>

<h1>Conclusions</h1>

<p>Scenic has much more to offer and it’s a very useful tool to have in your toolbox. I can highly recommend getting acquainted with it and utilise database views in your everyday backend work.</p>
<div class="work-with-us"><p>At Ragnarson we help companies deliver great products. We take care of development and deployment so that they can focus on growing the product and working with customers.</p><a class="btn" href="https://ragnarson.com/?utm_source=ragnarson&utm_medium=blog&utm_campaign=work-with-us#contact">Work with us</a></div><div class="article-comments"><div id="commento"></div>
<script src="https://cdn.commento.io/js/commento.js"></script>
</div></div><footer><div class="text--center"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-footer"><img src="/images/ragnar-desk-c0d025368e.png" srcset="/images/ragnar-desk-c0d025368e.png 1x, /images/ragnar-desk-2x-c0332b062e.png 2x" alt="Ragnar desk" /></a></div></footer></div><script src="/javascripts/application-c0ec307bf9.js"></script></body></html>