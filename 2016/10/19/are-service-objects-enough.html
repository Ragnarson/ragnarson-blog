<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>Are service objects enough? - Ragnarson Blog</title><meta content="summary" name="twitter:card" /><meta content="@ragnarsoncom" name="twitter:site" /><meta content="Ragnarson Blog" property="og:site_name" /><meta content="article" property="og:type" /><meta content="https://blog.ragnarson.com/2016/10/19/are-service-objects-enough.html" property="og:url" /><meta content="Are service objects enough?" property="og:title" /><meta content="There have been a lot of buzz around service objects in Ruby community. It started some time ago and new articles about them popped up like mushrooms. I still think about myself as a “developer in progress” and I think it’s a good approach for all of us. We should always keep learning new stuff. For me, the so-called service objects were like a milestone. A lot of things started to look simpler with them. So how does the perfect implementation of service objects looks to me?" property="og:description" /><meta content="Dawid Lenkiewicz" name="author" /><meta content="https://blog.ragnarson.com/2016/10/19/are-service-objects-enough/cover-c04fcea6ed.png" property="og:image" /><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Lato:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":"Ragnarson Blog","url":"https://blog.ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Person","name":"Dawid Lenkiewicz","image":"https://www.gravatar.com/avatar/01caa77a1f122a1371fed292cab37c72.jpg?s=144&d=mm"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","headline":"Are service objects enough?","url":"https://blog.ragnarson.com/2016/10/19/are-service-objects-enough.html","author":{"@type":"Person","name":"Dawid Lenkiewicz","image":"https://www.gravatar.com/avatar/01caa77a1f122a1371fed292cab37c72.jpg?s=144&d=mm"},"publisher":{"@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com","logo":"https://blog.ragnarson.com/images/brand-c0054f1cec.svg"},"datePublished":"2016-10-19","dateModified":"2016-10-19","image":"https://blog.ragnarson.com/2016/10/19/are-service-objects-enough/cover-c04fcea6ed.png"}</script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/stylesheets/application-c0f3339569.css" rel="stylesheet" /><link href="/favicon-152-c0fe5a334d.png" rel="apple-touch-icon-precomposed" /><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-11839548-2');
ga('set', 'allowAdFeatures', false);
ga('set', 'anonymizeIp', true);
ga('send', 'pageview');
</script>
</head><body><div class="container nav-container"><nav class="navbar navbar-dark navbar-toggleable-md"><button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" data-target="#navbarResponsive" data-toggle="collapse" type="button"><i class="icon-menu"></i></button><a href="https://ragnarson.com" class="nav-brand navbar-logo"><img src="/images/brand-c0054f1cec.svg" title="Ragnarson Blog" width="220px" alt="Brand" /></a><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="nav navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Why us</a><div class="dropdown-menu"><a href="https://ragnarson.com/our-story/" class="dropdown-item">Our story</a><a href="https://ragnarson.com/core-values/" class="dropdown-item">Core Values</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Services</a><div class="dropdown-menu"><a href="https://ragnarson.com/services/web-app-development/" class="dropdown-item">Web app development</a><a href="https://ragnarson.com/services/infrastructure-and-devops/" class="dropdown-item">Infrastructure and DevOps</a></div></li><li class="nav-item"><a href="https://ragnarson.com/case-studies/" class="nav-link">Case studies</a></li><li class="nav-item"><a href="https://ragnarson.com/community/" class="nav-link">Community</a></li><li class="nav-item"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-header#contact" class="nav-link">Contact</a></li><li class="nav-item"><a href="/" class="active nav-link">Blog</a></li><li class="nav-item"><a href="http://jobs.ragnarson.com" class="nav-link">Jobs</a></li></ul></div></nav></div><div class="newsletter-show newsletter-container" id="js-box"><div class="newsletter-toggler"><i class="icon-chevron-right" id="js-arrow"></i></div><div class="newsletter-box"><div class="newsletter-popup"><div id="mc_embed_signup">
  <form action="//ragnarson.us10.list-manage.com/subscribe/post?u=6a4a4d00f989604300f83d3de&amp;id=6adadf2f44" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL" class="newsletter-label">
        Sign up for our newsletter and get notifications about new articles on your email
      </label>

      <div class="row">
        <div class="three-thirds">
          <input type="email" value="" name="EMAIL" class="newsletter-input" id="mce-EMAIL" placeholder="Your email address" required>

          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
          <div class="signup_hidden">
            <input type="text" name="b_6a4a4d00f989604300f83d3de_6adadf2f44" tabindex="-1" value="" class="one-half">
          </div>
        </div>

        <div class="mt-3 text-center">
          <input type="submit" value="Join our newsletter" name="subscribe" id="mc-embedded-subscribe" class="btn newsletter-btn">
        </div>
      </div>
    </div>
  </form>
</div>
</div></div></div><div id="main" role="main"><div class="article"><header><img src="https://www.gravatar.com/avatar/01caa77a1f122a1371fed292cab37c72.jpg?s=144&amp;d=mm" class="avatar" width="72px" size="72px" alt="01caa77a1f122a1371fed292cab37c72" /><div class="article-meta">October 19, 2016 - <a href="/authors/dawid-lenkiewicz.html">Dawid Lenkiewicz</a>  in <a href="/categories/development.html">development</a></div><h1 class="article-title"><a href="/2016/10/19/are-service-objects-enough.html">Are service objects enough?</a></h1></header><img src='/2016/10/19/are-service-objects-enough/cover-c04fcea6ed.png'/><p>There have been a lot of buzz around service objects in Ruby community. It started some time ago and new articles about them popped up like mushrooms. I still think about myself as a “developer in progress” and I think it’s a good approach for all of us. We should always keep learning new stuff. For me, the so-called service objects were like a milestone. A lot of things started to look simpler with them. So how does the perfect implementation of service objects looks to me?</p>

<p></p>

<h2>The perfect world</h2>

<p>I assume that we all know what service objects are. If you are not familiar with them there is a ton of great articles about them. You can check <a href="http://sporto.github.io/blog/2012/11/15/a-pattern-for-service-objects-in-rails/">here</a> or <a href="https://blog.engineyard.com/2014/keeping-your-rails-controllers-dry-with-services">here</a> how to use them with Rails applications.</p>

<p>So we all know the main concepts: it should be a small class that does just one thing - some operation. It should be easy to test and not coupled your Rails application. But the problem is there are still a lot of questions about implementation details when using them in big projects.</p>

<p>What if we need to add some logic to existing service object? Should we create another service object and run it after the first one? Or should we process it within the initial one? What should we do if we want to get some data from service object after it does its job? Should we create some reader / method or return needed value from the main method? Should service objects even return something?</p>

<p>As you can see all these things can lead to long discussions in your pull requests. It’s good to think about these problems at the beginning.</p>

<p>Let’s assume we are implementing some registration functionality. We need to create a user and then send a welcome mail with some unique token inside.</p>

<h2>Are service objects enough?</h2>

<p>So how can we implement it? There are basically 3 things we need to cover:</p>

<ul>
<li>Creating a new user record in the database</li>
<li>Generating some unique token for created user</li>
<li>Sending a welcome mail with the token inside</li>
</ul>

<p>It’s worth splitting those tasks to separate and small service objects. But in reality, we are still talking about one action for the end user - registration. That&#39;s why it makes sense to introduce another layer of abstraction in our codebase - the commands. They are like glue to our service objects. The idea of it is: We call a command object from our controller and it can call many service objects.</p>

<h2>The return value</h2>

<p>For command objects, I really like the approach of broadcasting events, like in <a href="https://github.com/krisleech/wisper">wisper</a> gem. It solves one of the most important problems for me - the return value. Many times have I seen inconsistency in this area, for example:</p>
<pre class="highlight ruby"><code><span class="no">User</span><span class="o">::</span><span class="no">NotifyAdmins</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</code></pre>

<p>No return value. The service object is just responsible for sending email or message on Slack.</p>

<hr>
<pre class="highlight ruby"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">::</span><span class="no">Create</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">if</span> <span class="no">User</span><span class="o">::</span><span class="no">Contracts</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre>

<p>Returning some data from the main service object method. It can be some record or boolean value. We can just assume what it really is.</p>

<hr>
<pre class="highlight ruby"><code><span class="n">user_creation</span> <span class="o">=</span> <span class="no">User</span><span class="o">::</span><span class="no">Create</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">user_creation</span><span class="p">.</span><span class="nf">call</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">user_creation</span><span class="p">.</span><span class="nf">created_user</span>
</code></pre>

<p>Explicitly returns a user with separate method / reader. All the examples above are just inconsistent. It can be confusing, harder to understand for new developers and even more difficult to test.</p>

<hr>

<p>With the <strong>wisper</strong> gem we don’t return any value from calling the command itself. We just add listeners in controllers for every possible event we implement. Those events can include needed arguments when we need to get some data. Seems confusing? Let’s look at the example:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span><span class="o">::</span><span class="no">Register</span>
  <span class="kp">include</span> <span class="no">Wisper</span><span class="o">::</span><span class="no">Publisher</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">broadcast</span><span class="p">(</span><span class="ss">:invalid</span><span class="p">)</span> <span class="k">if</span> <span class="n">email</span><span class="p">.</span><span class="nf">blank?</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">)</span>
    <span class="n">broadcast</span><span class="p">(</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">controller</span> <span class="n">action</span>
<span class="p">.</span><span class="nf">.</span><span class="p">.</span>

<span class="nf">def</span> <span class="n">create</span>
  <span class="n">register_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">::</span><span class="no">Register</span><span class="p">.</span><span class="nf">new</span>

  <span class="n">register_user</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="ss">:invalid</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">flash</span><span class="p">.</span><span class="nf">now</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Email address is missing"</span>
    <span class="n">render</span> <span class="ss">:new</span>
  <span class="k">end</span>

  <span class="n">register_user</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">user_id</span><span class="o">|</span> <span class="n">redirect_to</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">register_user</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>

<p>That&#39;s the first step of our implementation of the command object. I would put this class in the <code>app/commands/user</code> folder and move on to adding further things.</p>

<h2>Using service objects</h2>

<p>So what about the so-called service objects? In my approach, they are still useful for doing one small thing and returning some value. In our example, they could generate  a unique token. A small class like:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span><span class="o">::</span><span class="no">GenerateToken</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="kp">new</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">call</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="p">(</span><span class="n">generate</span> <span class="n">and</span> <span class="k">return</span> <span class="n">token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>is really easy to test in isolation and can be easily added to our command object. So the final implementation would look like:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span><span class="o">::</span><span class="no">Register</span>
  <span class="kp">include</span> <span class="no">Wisper</span><span class="o">::</span><span class="no">Publisher</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">broadcast</span><span class="p">(</span><span class="ss">:invalid</span><span class="p">)</span> <span class="k">if</span> <span class="n">email</span><span class="p">.</span><span class="nf">blank?</span>

    <span class="n">user</span>  <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="no">User</span><span class="o">::</span><span class="no">GenerateToken</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">token</span><span class="p">).</span><span class="nf">deliver_later</span>

    <span class="n">broadcast</span><span class="p">(</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This allows us to extend or change our class in the future with little time. We could also broadcast more events with some other validation.</p>

<h2>The way to call commands</h2>

<p>There is still one thing we could improve in my opinion. I’m not sold on the way we call command objects in our controllers. I suggest creating a base module for our commands:</p>
<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">BaseCommand</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="kp">include</span> <span class="no">Wisper</span><span class="o">::</span><span class="no">Publisher</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="kp">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">).</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">obj</span><span class="o">|</span> <span class="k">yield</span> <span class="n">obj</span> <span class="p">}.</span><span class="nf">call</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Now change the <code>User::Register</code> class to:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span><span class="o">::</span><span class="no">Register</span>
  <span class="kp">include</span> <span class="no">BaseCommand</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">email</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="k">return</span> <span class="n">broadcast</span><span class="p">(</span><span class="ss">:invalid</span><span class="p">)</span> <span class="k">if</span> <span class="n">email</span><span class="p">.</span><span class="nf">blank?</span>

    <span class="n">user</span>  <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="no">User</span><span class="o">::</span><span class="no">GenerateToken</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">token</span><span class="p">).</span><span class="nf">deliver_later</span>

    <span class="n">broadcast</span><span class="p">(</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="kp">attr_reader</span> <span class="ss">:email</span>
<span class="k">end</span>
</code></pre>

<p>This way we don’t need to instantiate command object and can use it in controllers like:</p>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="no">User</span><span class="o">::</span><span class="no">Register</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span> <span class="k">do</span> <span class="o">|</span><span class="n">register_user</span><span class="o">|</span>
    <span class="n">register_user</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="ss">:invalid</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">flash</span><span class="p">.</span><span class="nf">now</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Email address is missing"</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>

    <span class="n">register_user</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">user_id</span><span class="o">|</span> <span class="n">redirect_to</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>I think it looks awesome!</p>

<p>It’s also worth adding that there is a <a href="https://github.com/krisleech/wisper-rspec">wisper-rspec</a> gem which helps with testing when using Rspec. You can test if command broadcasts proper event or stub them in requests specs.</p>

<h2>Wrapping up</h2>

<p>If you want a clean architecture in your app, consider adding the command objects layer. There are places where you need to perform few operations one after another. If you could group them into one, logical action, you got a place for command. They should call service objects or perform some simple logic by itself. I also recommend you to try the <a href="https://github.com/krisleech/wisper">wisper</a> library. It can clean your controllers and add some guidelines for other developers. It should help with keeping your code clean, easy to test and maintainable in the future.</p>
<div class="work-with-us"><p>At Ragnarson we help companies deliver great products. We take care of development and deployment so that they can focus on growing the product and working with customers.</p><a class="btn" href="https://ragnarson.com/?utm_source=ragnarson&utm_medium=blog&utm_campaign=work-with-us#contact">Work with us</a></div><div class="article-comments"><div id="commento"></div>
<script src="https://cdn.commento.io/js/commento.js"></script>
</div></div><footer><div class="text--center"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-footer"><img src="/images/ragnar-desk-c0d025368e.png" srcset="/images/ragnar-desk-c0d025368e.png 1x, /images/ragnar-desk-2x-c0332b062e.png 2x" alt="Ragnar desk" /></a></div></footer></div><script src="/javascripts/application-c0ec307bf9.js"></script></body></html>