<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>Code your own bitcoin transaction - Ragnarson Blog</title><meta content="summary" name="twitter:card" /><meta content="@ragnarsoncom" name="twitter:site" /><meta content="Ragnarson Blog" property="og:site_name" /><meta content="article" property="og:type" /><meta content="https://blog.ragnarson.com/2017/04/06/code-your-own-bitcoin-transaction.html" property="og:url" /><meta content="Code your own bitcoin transaction" property="og:title" /><meta content="Today we will code our first bitcoin transaction. To achieve this goal we will use JavaScript library called bitcore. JavaScript is the most popular, modern programming language and almost every developer knows it, so it makes this article universal and useful for the wider audience." property="og:description" /><meta content="Piotr Misiurek" name="author" /><meta content="https://blog.ragnarson.com/2017/04/06/code-your-own-bitcoin-transaction/cover-c0e0d69e30.png" property="og:image" /><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Lato:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css" /><script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":"Ragnarson Blog","url":"https://blog.ragnarson.com"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Person","name":"Piotr Misiurek","image":"https://www.gravatar.com/avatar/5122e54437a4b89911623dfbe9a2f3c4.jpg?s=144&d=mm"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","headline":"Code your own bitcoin transaction","url":"https://blog.ragnarson.com/2017/04/06/code-your-own-bitcoin-transaction.html","author":{"@type":"Person","name":"Piotr Misiurek","image":"https://www.gravatar.com/avatar/5122e54437a4b89911623dfbe9a2f3c4.jpg?s=144&d=mm"},"publisher":{"@type":"Organization","name":"Ragnarson","url":"https://ragnarson.com","logo":"https://blog.ragnarson.com/images/brand-c0054f1cec.svg"},"datePublished":"2017-04-06","dateModified":"2017-04-06","image":"https://blog.ragnarson.com/2017/04/06/code-your-own-bitcoin-transaction/cover-c0e0d69e30.png"}</script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/stylesheets/application-c0f3339569.css" rel="stylesheet" /><link href="/favicon-152-c0fe5a334d.png" rel="apple-touch-icon-precomposed" /><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-11839548-2');
ga('set', 'allowAdFeatures', false);
ga('set', 'anonymizeIp', true);
ga('send', 'pageview');
</script>
</head><body><div class="container nav-container"><nav class="navbar navbar-dark navbar-toggleable-md"><button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right" data-target="#navbarResponsive" data-toggle="collapse" type="button"><i class="icon-menu"></i></button><a href="https://ragnarson.com" class="nav-brand navbar-logo"><img src="/images/brand-c0054f1cec.svg" title="Ragnarson Blog" width="220px" alt="Brand" /></a><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="nav navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Why us</a><div class="dropdown-menu"><a href="https://ragnarson.com/manifesto" class="dropdown-item">Manifesto</a><a href="https://ragnarson.com/team" class="dropdown-item">Team</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Services</a><div class="dropdown-menu"><a href="https://ragnarson.com/software-development" class="dropdown-item">Software Development</a><a href="https://ragnarson.com/fund" class="dropdown-item">Fund</a><a href="https://ragnarson.com/advisory" class="dropdown-item">Advisory</a></div></li><li class="nav-item"><a href="https://ragnarson.com/case-studies" class="nav-link">Case studies</a></li><li class="nav-item"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-header#the-contact-form" class="nav-link">Contact</a></li><li class="nav-item"><a href="/" class="active nav-link">Blog</a></li><li class="nav-item"><a href="https://ragnarson.com/careers" class="nav-link">Careers</a></li></ul></div></nav></div><div class="newsletter-show newsletter-container" id="js-box"><div class="newsletter-toggler"><i class="icon-chevron-right" id="js-arrow"></i></div><div class="newsletter-box"><div class="newsletter-popup"><div id="mc_embed_signup">
  <form action="//ragnarson.us10.list-manage.com/subscribe/post?u=6a4a4d00f989604300f83d3de&amp;id=6adadf2f44" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL" class="newsletter-label">
        Sign up for our newsletter and get notifications about new articles on your email
      </label>

      <div class="row">
        <div class="three-thirds">
          <input type="email" value="" name="EMAIL" class="newsletter-input" id="mce-EMAIL" placeholder="Your email address" required>

          <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
          <div class="signup_hidden">
            <input type="text" name="b_6a4a4d00f989604300f83d3de_6adadf2f44" tabindex="-1" value="" class="one-half">
          </div>
        </div>

        <div class="mt-3 text-center">
          <input type="submit" value="Join our newsletter" name="subscribe" id="mc-embedded-subscribe" class="btn newsletter-btn">
        </div>
      </div>
    </div>
  </form>
</div>
</div></div></div><div id="main" role="main"><div class="article"><header><img src="https://www.gravatar.com/avatar/5122e54437a4b89911623dfbe9a2f3c4.jpg?s=144&amp;d=mm" class="avatar" width="72px" size="72px" alt="5122e54437a4b89911623dfbe9a2f3c4" /><div class="article-meta">April  6, 2017 - <a href="/authors/piotr-misiurek.html">Piotr Misiurek</a>  in <a href="/categories/development.html">development</a>, <a href="/categories/blockchain.html">blockchain</a></div><h1 class="article-title"><a href="/2017/04/06/code-your-own-bitcoin-transaction.html">Code your own bitcoin transaction</a></h1></header><img src='/2017/04/06/code-your-own-bitcoin-transaction/cover-c0e0d69e30.png'/><p>Today we will code our first bitcoin transaction. To achieve this goal we will use JavaScript library called <a href="https://github.com/bitpay/bitcore-lib">bitcore</a>. JavaScript is the most popular, modern programming language and almost every developer knows it, so it makes this article universal and useful for the wider audience.</p>

<p></p>

<p>Before you continue to read the article, you should have at least basic technical knowledge about how bitcoin blockchain works. If not please dedicate a few minutes to read <a href="https://blog.ragnarson.com/2016/12/01/blockchains-a-brief-introduction.html">brief introduction to blockchain</a>. If you have more time, like a few hours, I recommend you to read <a href="https://github.com/bitcoinbook/bitcoinbook/tree/develop">Mastering Bitcoin</a>.</p>

<p><a href="https://docs.npmjs.com/cli/init">Let&#39;s start with a new NPM project</a> with following dependencies:</p>
<pre class="highlight plaintext"><code>[...]
"dependencies": {
    "bitcore-explorers": "^1.0.1",
    "bitcore-lib": "^0.13.19"
}
[...]
</code></pre>

<p>Open <code>index.js</code> file and import <code>bitcore</code> library:</p>
<pre class="highlight plaintext"><code>var bitcore = require("bitcore-lib");
</code></pre>

<p>To spend bitcoins we need an address that contains bitcoins and a private key that allows us to spend it. We will import the private key in <code>WIF</code> version. <code>WIF</code> is an abbreviation of <code>Wallet Import Format</code>. It is in use to easily import keys between bitcoin wallets.
Then we will create a testnet address from that private key:</p>
<pre class="highlight plaintext"><code>var privateKeyWIF = 'cQN511BWtc2dSUMWySmZpr6ShY1un4WK42JegGwkSFX5a8n9GWr3';
var privateKey = bitcore.PrivateKey.fromWIF(privateKeyWIF);
var sourceAddress = privateKey.toAddress(bitcore.Networks.testnet);
</code></pre>

<p>WARNING! In that example, I share with you my private key. You shouldn&#39;t do that in real life. The one who has the private key is the owner of the bitcoins allocated to address made from this key. It is a sign of the ownership.</p>

<p>In this case, I just shared with you the key used to create a testnet address. Testnet is a bitcoin network created for software and scripts testing. It doesn&#39;t contain real bitcoins, only the test ones. You can gain them for free. Even if someone steals them it is not a big deal. I can take that risk to provide you a working out of the box example.</p>

<p>If someone used/stole all test bitcoins from this address you can recharge it. Copy the address <code>mibK5jk9eP7EkLH175RSPGTLR27zphvvxa</code> and <a href="http://tpfaucet.appspot.com/">paste it in the form</a></p>

<p>It is time to create our <code>targetAddress</code> where we want to sent our test bitcoins.</p>
<pre class="highlight plaintext"><code>var targetAddress = (new bitcore.PrivateKey).toAddress(bitcore.Networks.testnet);
</code></pre>

<p>Let&#39;s check our source address if any bitcoins remained there. Bitcoin network use <code>UTXO</code> to store that information. <code>UTXO</code> is an abbreviation of <a href="https://bitcoin.org/en/glossary/unspent-transaction-output">Unspent Transaction Output</a>.</p>

<p>Houston, we have a problem. We don&#39;t have a bitcoin network client. The full node requires at least 125 GB of hard drive space which is too much for my poor MacBook Air. We have to find a workaround. We have to ask someone to read the Bitcoin network for us. And to broadcast our transaction as well.</p>

<p>In this case, we are losing the biggest advantage of bitcoin blockchain. The architecture of the system makes us don&#39;t have to trust any parties. The network consensus, the math and the encryption make the data stored in blockchain trusted. But now we are asking middleman to read this data for us. He might provide us fake or outdated data.</p>

<p>We will use <code>Insight</code> from <code>bitcore-explorers</code> library. As it is quite popular and we are only learning here we can assume it can be trusted. The final solution should be to have our own Bitcoin full node.</p>

<p>Ok, let&#39;s use <code>Insight</code> to check how many Bitcoins we have to spend.</p>
<pre class="highlight plaintext"><code>var Insight = require("bitcore-explorers").Insight;
var insight = new Insight("testnet");

insight.getUnspentUtxos(sourceAddress, function(error, utxos) {
  if (error) {
    console.log(error);
  } else {
    console.log(utxos);
    // transaction code goes here
}
</code></pre>

<p>The output of <code>UTXOs</code> is an array. Each of its element contains info about the address that is a owner of <code>UTXO</code> and an amount of Satoshis (<code>1 Satoshi = 0.00000001 Bitcoin</code>). It looks like this:</p>
<pre class="highlight plaintext"><code>[ &lt;UnspentOutput: dbe9ce2ae27d7ffcba40195e7ee628e9165568115931386b27b0c0674fa019c5:1, satoshis: 5047177248, address: mibK5jk9eP7EkLH175RSPGTLR27zphvvxa&gt; ]
</code></pre>

<p>It is time to create our transaction:</p>
<pre class="highlight plaintext"><code>var tx = new bitcore.Transaction();

</code></pre>

<p>Let&#39;s set the received <code>UTXOs</code> as an <code>input</code> of the transaction. An important thing to notice: we are not getting bitcoins from <code>address</code> but from <code>UTXOs</code></p>
<pre class="highlight plaintext"><code>tx.from(utxos);
</code></pre>

<p>Let&#39;s set the receiver of our transaction and amount we want to deliver to him. The amount is given in <code>Satoshis</code>, the smallest unit of Bitcoin: <code>1 Satoshi = 0.00000001 Bitcoin</code>. This is the <code>output</code> of our transaction:</p>
<pre class="highlight plaintext"><code>tx.to(targetAddress, 10000);
</code></pre>

<p>It is time to talk about <code>the change</code>. <code>UTXOs</code> are the output from transactions that point to our address and have not been spent yet. <code>UTXOs</code> are like a bank note. If you have 5 dollar note in your pocket and want to buy 2$ beer you don&#39;t cut a part of the bill and give it to a cashier. You give the 5$ note and receive 3$ change. It works exactly the same with <code>UTXOs</code>. You have to use entire <code>UTXO</code> in a transaction and specify the <code>change</code> value and <code>address</code> then the <code>change</code> should be returned.</p>

<p>WTF? Do I have to specify the <code>change</code> value? In shop when I buy 2$ dollar beer with 5$ note then I receive 3$ change in return. It is obvious. Nothing to be calculated.</p>

<p>In Bitcoin, there is a little difference. In reality, the <code>change</code> is just another output of a transaction. And the sum of <code>outputs</code> should be a little smaller than the sum of <code>input</code>. The difference is called <code>mining fee</code>. You pay it to the miners to be included in the transactions block. The wallets or libraries like <code>bitcore.io</code> estimate the <code>mining fee</code> for us. So in our case, we just specify the <code>address</code> where <code>change</code> should be returned.</p>
<pre class="highlight plaintext"><code>tx.change(sourceAddress);
</code></pre>

<p>You can notice that we use our <code>sourceAddress</code>. As a result, some of existing <code>UTXOs</code> for this address disappear (they will be spent already), but there will also be a new one created(the one from the <code>change</code>).</p>

<p>In real life, the wallets are using a new address for each of your transactions. The goal of that is to improve anonymity. How is it possible that from one <code>private key</code> the wallet is able to create many <code>public keys</code> and <code>addresses</code>? <a href="https://en.bitcoin.it/wiki/Deterministic_wallet">Read about Deterministic wallet to find the answer</a></p>

<p>Great! Everything is set! The only thing we have to do right now is to sign the transaction with our <code>private key</code> and send it to the Bitcoin blockchain. As I mentioned before we don&#39;t have our own bitcoin client. We use external tool to communicate with the blockchain. The question is: can we put trust in it.  When we broadcast transaction there is no risk that the tool will capture  private key or manipulate the transaction (change <code>targetAddress</code> for example). If the tool makes any changes listed above, then the signature will not be valid any more and transaction will be rejected. The only risk is that the tool won&#39;t sent the transaction at all. But we can verify it in a second with any blockchain explorer. So without fear, we can use <code>Insight</code> again:</p>
<pre class="highlight plaintext"><code>tx.sign(privateKey);
tx.serialize();

insight.broadcast(tx, function(error, transactionId) {
  if (error) {
    console.log(error);
  } else {
    console.log(transactionId);
  }
});
</code></pre>

<p>That&#39;s all folks! The transaction is broadcasted to the network. If everything goes well we will receive transaction id. Then copy and paste it in <a href="http://tbtc.blockr.io/">bitcoin blockchain explorer</a> to see if it really works.</p>

<p><a href="https://github.com/PiotrMisiurek/screw-it-lets-do-it/blob/829ae579c52112e216ed348cda15ed555744eccf/index.js">The entire code is available on GitHub</a></p>

<h3>What is next</h3>

<p>In the next bitcoin episode, we will code the <a href="https://en.bitcoin.it/wiki/Multisignature">multi-sig transaction</a></p>

<p>You are welcome to leave a tip, if you like the content:</p>

<ul>
<li>BTC: 14DgncjAnqM3Wd2pYyoJTXckSXuVv43cNx</li>
<li>ETH: 0x3e6bE376ef37D96bd3E7F792098c90B87B84B042</li>
</ul>
<div class="work-with-us"><p>At Ragnarson we help companies deliver great products. We take care of development and deployment so that they can focus on growing the product and working with customers.</p><a class="btn" href="https://ragnarson.com/?utm_source=ragnarson&utm_medium=blog&utm_campaign=work-with-us#contact">Work with us</a></div><div class="article-comments"><div id="commento"></div>
<script src="https://cdn.commento.io/js/commento.js"></script>
</div></div><footer><div class="text--center"><a href="https://ragnarson.com/?utm_source=ragnarson&amp;utm_medium=blog&amp;utm_campaign=blog-footer"><img src="/images/ragnar-desk-c0d025368e.png" srcset="/images/ragnar-desk-c0d025368e.png 1x, /images/ragnar-desk-2x-c0332b062e.png 2x" alt="Ragnar desk" /></a></div></footer></div><script src="/javascripts/application-c0ec307bf9.js"></script></body></html>